name: Filter Top RS Opportunities

on:
  workflow_dispatch: # Manual trigger
  workflow_run:
    workflows: ["Run VCP Stock Scanner"]
    types:
      - completed
    branches:
      - main

jobs:
  filter_top_rs:
    runs-on: ubuntu-latest
    # Only run if the VCP Stock Scanner workflow completed successfully or for workflow_dispatch
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'

    steps:
      # Print workflow start time
      - name: Print workflow start time (EDT)
        run: |
          echo "Workflow started at $(date -u -d '4 hours ago' +'%I:%M %p EDT on %A, %B %d, %Y')"

      # Check out the repository
      - name: üì• Checkout Repo
        uses: actions/checkout@v4

      # Set up Python environment
      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      # Install dependencies
      - name: üì¶ Install Dependencies
        run: pip install pandas

      # Run the RS opportunity filter script
      - name: üßÆ Run RS Opportunity Filter
        run: python scripts/filter_top_rs.py

      # Commit and push the results
      - name: üì§ Commit & Push Results
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          if ls IBD-20/rs_opportunities_*.csv 1> /dev/null 2>&1; then
            git add IBD-20/rs_opportunities_*.csv
            git commit -m "üìà Add RS Opportunities Report [$(date -u -d '4 hours ago' +'%I:%M %p EDT on %A, %B %d, %Y')]"
            git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          else
            echo "‚ö†Ô∏è No RS opportunity file found. Skipping commit."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Print workflow end time
      - name: Print workflow end time (EDT)
        run: |
          echo "Workflow ended at $(date -u -d '4 hours ago' +'%I:%M %p EDT on %A, %B %d, %Y')"
